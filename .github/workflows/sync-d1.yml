name: High-Fidelity D1 Sync

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'assets/meds.csv'
      - 'assets/data/**'
      - 'scripts/rebuild_d1_data.py'
      - 'export_mediswitch_to_sql.py'
      - 'd1_sql_chunks/**'

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Resilient Deploy to Cloudflare D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          MAIN_DB: "mediswitsh-db"
          INTERACTIONS_DB: "mediswitch-interactions"
        run: |
          # 1. Generate Chunks ONLY if source DB exists (Local Dev / Full Repo)
          if [ -f "assets/database/mediswitch.db" ]; then
            echo "ðŸš€ Database found! Generating SQL Chunks from source assets..."
            # Generate fresh schema and data chunks
            python3 scripts/generate_d1_schema.py
            python3 scripts/rebuild_d1_data.py
          else
            echo "âš ï¸ Source database not found (likely gitignored). Using pre-committed SQL chunks."
          fi
          
          echo "ðŸš€ Starting Resilient D1 Data Sync..."
          
          # Function to execute a pattern of files
          execute_folder() {
            local folder=$1
            local db_name=$2
            local label=$3
            
            echo "ðŸ“¦ Deploying $label to $db_name ($folder)..."
            FILES=$(find $folder -maxdepth 1 -name "*.sql" | sort)
            
            if [ -z "$FILES" ]; then
              echo "  âš ï¸ No files found in $folder."
              return
            fi
            
            for f in $FILES; do
              echo "  - Executing $f..."
              for i in {1..3}; do
                if npx wrangler d1 execute $db_name --yes --remote --file="$f"; then
                  echo "    âœ… Success: $f"
                  break
                else
                  if [ $i -eq 3 ]; then
                    echo "    âŒ ERROR: Failed after 3 attempts: $f"
                    exit 1
                  fi
                  echo "    âš ï¸ Attempt $i failed. Retrying in 5s..."
                  sleep 5
                fi
              done
              sleep 1
            done
          }
          
          # --- 1. MAIN DATABASE (Drugs, Dosages, Ingredients) ---
          echo "ðŸ”µ Syncing MAIN Database ($MAIN_DB)..."
          
          # Apply Schema
          if [ -f "cloudflare-worker/schema_generated.sql" ]; then
             echo "  ðŸ“„ Applying Main Schema..."
             npx wrangler d1 execute $MAIN_DB --yes --remote --file=cloudflare-worker/schema_generated.sql
          fi
          
          # Execute Chunks
          execute_folder "d1_sql_chunks/main" "$MAIN_DB" "Main Data"

          # --- 2. INTERACTIONS DATABASE ---
          echo "ðŸŸ£ Syncing INTERACTIONS Database ($INTERACTIONS_DB)..."
          
          # Apply Schema
          if [ -f "cloudflare-worker/schema_interactions.sql" ]; then
             echo "  ðŸ“„ Applying Interactions Schema..."
             npx wrangler d1 execute $INTERACTIONS_DB --yes --remote --file=cloudflare-worker/schema_interactions.sql
          fi
          
          # Execute Chunks
          execute_folder "d1_sql_chunks/interactions" "$INTERACTIONS_DB" "Interactions Data"
          
          echo "âœ… High-Fidelity Sync Complete!"
      
      - name: Final Database Verification
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ” Verifying D1 database counts..."
          npx wrangler d1 execute mediswitsh-db --remote --yes --command="SELECT (SELECT COUNT(*) FROM drugs) as drugs;"
          npx wrangler d1 execute mediswitch-interactions --remote --yes --command="SELECT COUNT(*) as interactions FROM drug_interactions;"
      
      - name: Detailed D1 Audit Report
        if: always()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "No audit script update yet." >> $GITHUB_STEP_SUMMARY
          echo "Please manually verify." >> $GITHUB_STEP_SUMMARY
          echo "**Main DB:** mediswitsh-db" >> $GITHUB_STEP_SUMMARY
          echo "**Interactions DB:** mediswitch-interactions" >> $GITHUB_STEP_SUMMARY
