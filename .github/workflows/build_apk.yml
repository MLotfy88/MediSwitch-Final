name: Build Android APK
run-name: Build by MLotfy88 at 2025-03-29 13:39:55

env:
  CURRENT_DATETIME: "2025-03-29 13:39:55"
  CURRENT_USER: "MLotfy88" 
  GRADLE_VERSION: "8.10.2"
  CMAKE_VERSION: "3.22.1"
  NDK_VERSION: "25.1.8937393"
  TZ: "UTC"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  actions: write
  checks: write
  deployments: write
  pages: write
  pull-requests: write
  security-events: write
  statuses: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          cmake --version

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Android SDK components
        run: |
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.0" \
            "ndk;${{ env.NDK_VERSION }}" \
            "cmake;${{ env.CMAKE_VERSION }}"
          echo "y" | sdkmanager --licenses

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true

      - name: Setup Local Properties
        run: |
          FLUTTER_SDK=$(dirname $(which flutter))
          echo "flutter.sdk=$FLUTTER_SDK" > android/local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" >> android/local.properties
          cat android/local.properties

      - name: Configure Gradle
        working-directory: android
        run: |
          mkdir -p ~/.gradle
          cat << EOF > ~/.gradle/gradle.properties
          org.gradle.java.home=$JAVA_HOME
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8 -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC
          org.gradle.daemon=true
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.caching=true
          android.useAndroidX=true
          android.enableJetifier=true
          android.enableR8=true
          android.enableD8=true
          android.ndkVersion=${{ env.NDK_VERSION }}
          EOF
          
          sed -i 's|\\|/|g' settings.gradle
          chmod +x ./gradlew
          ./gradlew wrapper --gradle-version=${{ env.GRADLE_VERSION }} --distribution-type=bin

      - name: Project Setup
        run: |
          flutter clean
          flutter pub get
          cd android
          ./gradlew clean --stacktrace --info
          ./gradlew dependencies --stacktrace --info
          cd ..

      - name: Build APK
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}
        run: |
          echo "Current Time: ${{ env.CURRENT_DATETIME }}"
          echo "Builder: ${{ env.CURRENT_USER }}"
          
          flutter build apk \
            --release \
            --verbose \
            --target-platform android-arm64

      - name: Create Build Info
        run: |
          {
            echo "Build Information"
            echo "================"
            echo "Build Time: ${{ env.CURRENT_DATETIME }}"
            echo "Builder: ${{ env.CURRENT_USER }}"
            echo "Workflow Run ID: ${{ github.run_id }}"
            echo ""
            echo "Environment Details"
            echo "==================="
            echo "Java Version: $(java -version 2>&1 | head -n 1)"
            echo "Gradle Version: ${{ env.GRADLE_VERSION }}"
            echo "CMake Version: ${{ env.CMAKE_VERSION }}"
            echo "NDK Version: ${{ env.NDK_VERSION }}"
            echo "Flutter Version: $(flutter --version | head -n 1)"
            echo "Dart Version: $(dart --version)"
          } > build_info.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error
          retention-days: 7

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build_info.txt
          retention-days: 7

      - name: Update Build Status
        if: always()
        run: |
          echo "Build Status Information"
          echo "======================="
          echo "Build completed at: ${{ env.CURRENT_DATETIME }}"
          echo "Builder: ${{ env.CURRENT_USER }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
