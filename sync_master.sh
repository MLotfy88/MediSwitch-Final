#!/bin/bash
# ุณูุฑุจุช ูุฒุงููุฉ ุดุงูู ููุญูู ูู D1

set -e  # ุฅููุงู ุนูุฏ ุฃู ุฎุทุฃ

echo "๐ ุจุฏุก ุนูููุฉ ุงููุฒุงููุฉ ุงููุญููุฉ ูู Cloudflare D1"
echo "========================================================"

# 1. ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ
if [ ! -f "mediswitch.db" ]; then
    echo "โ ุฎุทุฃ: mediswitch.db ุบูุฑ ููุฌูุฏุฉ!"
    echo "ูู ุจุชุดุบูู: python3 populate_mediswitch_final.py"
    exit 1
fi

# 2. ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ
echo ""
echo "๐ ุงูุฎุทูุฉ 1: ูุญุต ุฌูุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ..."
python3 audit_database.py
if [ $? -ne 0 ]; then
    echo "โ๏ธ ุชุญุฐูุฑ: ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ ุจูุง ูุดุงูู!"
    read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ุฑุบู ุฐููุ (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 3. ุชูููุฏ ูููุงุช SQL ูู ุงููุงุนุฏุฉ ุงููุญููุฉ
echo ""
echo "๐ง ุงูุฎุทูุฉ 2: ุชูููุฏ ูููุงุช SQL ูู mediswitch.db..."
rm -rf d1_sql_chunks/
python3 scripts/rebuild_d1_data.py

# ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุชูููุฏ
if [ ! -d "d1_sql_chunks" ] || [ -z "$(ls -A d1_sql_chunks)" ]; then
    echo "โ ูุดู ุชูููุฏ ูููุงุช SQL!"
    exit 1
fi

echo "โ ุชู ุชูููุฏ $(ls d1_sql_chunks/*.sql | wc -l) ููู SQL"

# 4. ุนุฑุถ ุนููุฉ ูู ุงููููุงุช ููุชุฃูุฏ
echo ""
echo "๐ ุนููุฉ ูู ุฃูู ููู (ููุชุญูู):"
head -n 5 d1_sql_chunks/d1_import_part_000.sql

# 5. ุงูุงุฎุชูุงุฑ: ุฑูุน ูู GitHub ุฃู ูุฒุงููุฉ ูุจุงุดุฑุฉ
echo ""
echo "๐ค ุงูุฎุทูุฉ 3: ุงุฎุชุฑ ุทุฑููุฉ ุงููุฒุงููุฉ:"
echo "  1) ุฑูุน ุงููููุงุช ูู GitHub ุซู ุชุดุบูู Workflow (ุฃุณุฑุน)"
echo "  2) ูุฒุงููุฉ ูุจุงุดุฑุฉ ูู ููุง (ุฃุจุทุฃ ููู ูุจุงุดุฑ)"
read -p "ุงุฎุชูุงุฑู (1 ุฃู 2): " choice

if [ "$choice" == "1" ]; then
    echo ""
    echo "๐ฆ ุฑูุน ูููุงุช SQL ูู GitHub..."
    git add d1_sql_chunks/
    git add .gitignore  # ูู ุญุงู ุชู ุชุนุฏููู
    git commit -m "Update D1 SQL chunks from verified mediswitch.db"
    git push
    
    echo ""
    echo "โ ุชู ุงูุฑูุน ุจูุฌุงุญ!"
    echo "๐ ุงูุขู ุงุฐูุจ ูู GitHub Actions ูุดุบู Workflow: 'High-Fidelity D1 Sync'"
    
elif [ "$choice" == "2" ]; then
    echo ""
    echo "๐ ุจุฏุก ุงููุฒุงููุฉ ุงููุจุงุดุฑุฉ..."
    python3 sync_to_d1_master.py
    
    echo ""
    echo "โ ุชูุช ุงููุฒุงููุฉ ุงููุจุงุดุฑุฉ!"
else
    echo "โ ุงุฎุชูุงุฑ ุบูุฑ ุตุญูุญ!"
    exit 1
fi

echo ""
echo "๐ ุงูุชูุช ุงูุนูููุฉ ุจูุฌุงุญ!"
echo "========================================================"
