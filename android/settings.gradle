// android/settings.gradle (الكود المعدل مرة ثالثة)

pluginManagement {
    def flutterSdkRoot = System.getenv('FLUTTER_ROOT')
    if (flutterSdkRoot == null) {
        def localProperties = new Properties()
        def localPropertiesFile = new File(rootProject.projectDir, 'local.properties')
        if (localPropertiesFile.exists()) {
            localPropertiesFile.withReader('UTF-8') { reader ->
                localProperties.load(reader)
            }
            flutterSdkRoot = localProperties.getProperty('flutter.sdk')
        }
    }
    assert flutterSdkRoot != null, "Flutter SDK path not found. Define FLUTTER_ROOT environment variable or flutter.sdk in local.properties."

    includeBuild("${flutterSdkRoot}/packages/flutter_tools/gradle")

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id 'dev.flutter.flutter-plugin-loader' version '1.0.0'
    id 'com.android.application' version '8.1.0' apply false
    id 'org.jetbrains.kotlin.android' version '1.8.22' apply false
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        google()
        mavenCentral()

        // *** الخطوة الجديدة: إضافة مستودع Flutter SDK المحلي ***
        // هذا ضروري للعثور على تبعيات مثل flutter_embedding_release
        // نستخدم نفس المتغير flutterSdkRoot الذي حصلنا عليه في pluginManagement
        def flutterSdkRoot = System.getenv('FLUTTER_ROOT') // أو قراءته مرة أخرى إذا لزم الأمر
         if (flutterSdkRoot == null) {
             def localProperties = new Properties()
             def localPropertiesFile = new File(rootProject.projectDir, 'local.properties')
             if (localPropertiesFile.exists()) {
                 localPropertiesFile.withReader('UTF-8') { reader ->
                     localProperties.load(reader)
                 }
                 flutterSdkRoot = localProperties.getProperty('flutter.sdk')
             }
         }
        if (flutterSdkRoot != null) {
             // المسار الشائع الذي يحتوي على هذه الـ artifacts
             maven {
                 url "${flutterSdkRoot}/bin/cache/artifacts/engine/android-arm64-release" // للمنصة الأساسية في CI
                 // يمكنك إضافة مسارات أخرى إذا كنت تستهدف منصات متعددة في نفس البناء
                 // url "${flutterSdkRoot}/bin/cache/artifacts/engine/android-x64-release"
                 // url "${flutterSdkRoot}/bin/cache/artifacts/engine/android-x86-release"
                 // url "${flutterSdkRoot}/bin/cache/artifacts/engine/android-arm-release"
             }
             // أحيانًا تكون هناك حاجة لمستودع الحزم أيضًا
             maven {
                 url "${flutterSdkRoot}/bin/cache/pkg/sky_engine/lib"
             }
        } else {
            // تحذير إذا لم يتم العثور على المسار
             println "Warning: FLUTTER_ROOT not found. Local Flutter dependencies may not be resolved."
        }
        // *******************************************************
    }
}

include ':app'
