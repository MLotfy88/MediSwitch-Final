name: Daily DailyMed Sync
# Fetches updates from DailyMed API, patches local files, and syncs to D1

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 12:00 UTC
  workflow_dispatch:      # Manual trigger

jobs:
  daily-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install requests pandas
      
      - name: Fetch Daily Updates
        run: |
          # Fetch last 24h updates from DailyMed
          python3 scripts/fetch_daily_updates.py --days 1
      
      - name: Patch Local Database
        run: |
          # Merge updates into main files
          # Dosages
          python3 scripts/patch_database.py dosages production_data/production_hybrid.jsonl "production_data/updates/update_dosages_*.jsonl"
          
          # Interactions
          python3 scripts/patch_database.py interactions production_data/dailymed_interactions.json "production_data/updates/update_interactions_*.json"
      
      - name: Sync to Cloudflare D1
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          python3 scripts/sync_updates_to_d1.py \
            --dosages "production_data/updates/update_dosages_*.jsonl" \
            --interactions "production_data/updates/update_interactions_*.json" \
            --account-id "$CLOUDFLARE_ACCOUNT_ID" \
            --database-id "$D1_DATABASE_ID" \
            --api-token "$CLOUDFLARE_API_TOKEN"
            
      - name: Commit & Push Changes
        run: |
          git config --global user.name 'DailyMed Bot'
          git config --global user.email 'bot@dailymed.local'
          git add production_data/production_hybrid.jsonl production_data/dailymed_interactions.json
          git add assets/data/dosage_guidelines.json assets/data/drug_interactions.json
          git commit -m "data: daily update $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
