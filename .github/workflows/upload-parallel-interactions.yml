name: Parallel Interaction Upload

on:
  workflow_dispatch:
  push:
    paths:
      - 'd1_upload_chunks_new/**' # Trigger when new chunks are pushed

jobs:
  upload-parallel:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 20 parallel jobs to maximize speed
        group: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Upload Group ${{ matrix.group }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DB_NAME: "mediswitch-interactions"
        run: |
          # Get all chunk files sorted
          ALL_FILES=$(ls d1_upload_chunks_new/*.sql | sort)
          TOTAL_FILES=$(echo "$ALL_FILES" | wc -l)
          
          # Calculate range for this job
          FILES_PER_JOB=$(( (TOTAL_FILES + 19) / 20 ))
          START=$(( ${{ matrix.group }} * FILES_PER_JOB ))
          
          # Extract this job's slice of files
          MY_FILES=$(echo "$ALL_FILES" | sed -n "$((START + 1)),$((START + FILES_PER_JOB))p")
          
          echo "üöÄ Job ${{ matrix.group }} handling range $START to $((START + FILES_PER_JOB)) ($TOTAL_FILES total files)"
          
          for f in $MY_FILES; do
            if [ -z "$f" ]; then continue; fi
            echo "üì¶ Uploading $f..."
            
            # Retry logic (up to 3 times)
            SUCCESS=0
            for i in {1..3}; do
              if npx wrangler d1 execute $DB_NAME --remote --file="$f" -y; then
                SUCCESS=1
                break
              else
                echo "  ‚ö†Ô∏è Attempt $i failed for $f. Retrying..."
                sleep 5
              fi
            done
            
            if [ $SUCCESS -eq 0 ]; then
              echo "‚ùå ERROR: Failed to upload $f after 3 attempts."
              exit 1
            fi
          done
          
          echo "‚úÖ Group ${{ matrix.group }} finished successfully!"
