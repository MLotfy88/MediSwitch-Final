name: Monthly Drug Interaction Sync from OpenFDA

on:
  # Run on 10th of every month at midnight UTC
  schedule:
    - cron: '0 0 10 * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      files_to_process:
        description: 'Number of files to process (1-13)'
        required: false
        default: '13'

env:
  PYTHON_VERSION: '3.11'
  INTERACTIONS_OUTPUT: 'assets/data/drug_interactions.json'

jobs:
  sync-interactions:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests ijson pandas openpyxl
      
      - name: Download and Extract OpenFDA Interactions
        id: extract
        run: |
          echo "::group::Downloading OpenFDA Data"
          python3 scripts/interactions/download_and_extract_openfda.py
          echo "::endgroup::"
          
          # Get statistics
          INTERACTION_COUNT=$(python3 -c "import json; print(len(json.load(open('${{ env.INTERACTIONS_OUTPUT }}'))"))")
          echo "interaction_count=$INTERACTION_COUNT" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted $INTERACTION_COUNT interactions"
      
      - name: Validate Extracted Data
        run: |
          python3 -c "
          import json
          import sys
          
          data = json.load(open('${{ env.INTERACTIONS_OUTPUT }}'))
          
          # Validation checks
          assert len(data) > 100000, 'Too few interactions extracted'
          assert all('ingredient1' in i for i in data), 'Missing ingredient1'
          assert all('severity' in i for i in data), 'Missing severity'
          
          print(f'‚úÖ Validation passed: {len(data):,} interactions')
          "
      
      - name: Create Backup
        run: |
          if [ -f "${{ env.INTERACTIONS_OUTPUT }}" ]; then
            BACKUP_NAME="drug_interactions_backup_$(date +%Y%m%d).json"
            cp "${{ env.INTERACTIONS_OUTPUT }}" "assets/data/backups/$BACKUP_NAME"
            echo "‚úÖ Created backup: $BACKUP_NAME"
          fi
      
      - name: Upload to Cloudflare D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          echo "::group::Uploading to Cloudflare D1"
          python3 scripts/upload_interactions_d1.py \
            --json-file "${{ env.INTERACTIONS_OUTPUT }}" \
            --database-id "$D1_DATABASE_ID" \
            --account-id "$CLOUDFLARE_ACCOUNT_ID" \
            --api-token "$CLOUDFLARE_API_TOKEN"
          echo "::endgroup::"
      
      - name: Commit Updated Data
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add "${{ env.INTERACTIONS_OUTPUT }}"
          git add assets/data/backups/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TODAY=$(date +%Y-%m-%d)
            MESSAGE="üîÑ Monthly update: Drug interactions from OpenFDA ($TODAY)

            - Total interactions: ${{ steps.extract.outputs.interaction_count }}
            - Source: OpenFDA API
            - Auto-generated by GitHub Actions"

            git commit -m "$MESSAGE"
            
            git push
            echo "‚úÖ Changes committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## üìä Monthly Interaction Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Interactions Extracted:** ${{ steps.extract.outputs.interaction_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ \`${{ env.INTERACTIONS_OUTPUT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Cloudflare D1 Database" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Monthly Interaction Sync Failed',
              body: `The monthly drug interaction sync failed on ${new Date().toISOString()}.
              
              Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['automated', 'sync-failure']
            })
