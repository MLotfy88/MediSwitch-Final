# خطة عمل تطبيق MediSwitch

هذه خطة عمل منظمة ومرتبة لتطوير تطبيق MediSwitch بناءً على متطلبات المشروع والبيئة الحالية.

## المرحلة الأولى: إعداد البنية الأساسية للمشروع (الأولوية: عالية)

### 1. إعداد هيكل المشروع
- تحديث Gradle من الإصدار 7.6.3 إلى 8.9
- تحديث تبعيات Flutter إلى أحدث الإصدارات المتوافقة
- تحديث إصدار Gradle Plugin إلى 8.1.0
- تحديث إصدار Gradle إلى 8.9
- تحديث إصدار file_picker إلى 9.2.1
- تحديث compileSdk إلى 30
- تحديث sourceCompatibility و targetCompatibility إلى JavaVersion.VERSION_17
- تحديث jvmTarget إلى JavaVersion.VERSION_17
- إضافة ext.kotlin_version و ext.flutterRoot في android/app/build.gradle
- تحديث ndk.dir في android/gradle.properties
- إنشاء مفتاح debug keystore

### 2. إضافة التبعيات الأساسية
- إضافة التبعيات التالية إلى pubspec.yaml:
  ```yaml
  dependencies:
    flutter:
      sdk: flutter
    cupertino_icons: ^1.0.8
    sqflite_sqlcipher: ^2.2.1  # لتشفير قاعدة البيانات
    path_provider: ^2.1.2  # للوصول إلى مسارات النظام
    provider: ^6.1.2  # لإدارة الحالة
    shared_preferences: ^2.2.2  # لتخزين الإعدادات
    flutter_secure_storage: ^9.0.0  # لتخزين المفاتيح بشكل آمن
    excel: ^4.0.2  # للتعامل مع ملفات Excel
    csv: ^5.1.1  # للتعامل مع ملفات CSV
    file_picker: ^9.2.1  # لاختيار الملفات
    flutter_localizations:  # لدعم اللغة العربية
      sdk: flutter
    intl: ^0.18.1  # للترجمة والتنسيق
    google_fonts: ^6.2.1  # للخطوط (Noto Sans Arabic)
    flutter_animate: ^4.5.0  # للانتقالات السلسة
  ```

### 3. إعداد هيكل المجلدات
- إنشاء هيكل المجلدات التالي:
  ```
  lib/
    ├── main.dart
    ├── app.dart
    ├── config/
    │   ├── constants.dart
    │   ├── routes.dart
    │   └── themes.dart
    ├── models/
    │   ├── drug.dart
    │   ├── drug_interaction.dart
    │   ├── dose_equivalent.dart
    │   └── weight_dose_calculator.dart
    ├── screens/
    │   ├── home_screen.dart
    │   ├── search_screen.dart
    │   ├── dose_comparison_screen.dart
    │   ├── weight_calculator_screen.dart
    │   ├── settings_screen.dart
    │   └── backup_restore_screen.dart
    ├── services/
    │   ├── database_service.dart
    │   ├── database_update.dart
    │   ├── csv_import_service.dart
    │   ├── excel_import_service.dart
    │   └── backup_service.dart
    ├── utils/
    │   ├── encryption_helper.dart
    │   ├── csv_converter.dart
    │   └── validators.dart
    └── widgets/
        ├── drug_card.dart
        ├── search_bar.dart
        ├── dose_calculator.dart
        └── filter_options.dart
  ```

### 4. تمكين اتصال الجوال عبر Wi-Fi Debugging
- إضافة تعليمات لتمكين اتصال الجوال عبر Wi-Fi debugging لـ `flutter run`

## المرحلة الثانية: تطوير الوظائف الأساسية (الأولوية: عالية)

### 1. تشفير قاعدة البيانات (SQLCipher)
- دمج مكتبة SQLCipher في المشروع
- تنفيذ آلية لإنشاء وتخزين مفتاح التشفير بشكل آمن (جزئي)
- إصلاح مشكلة تهيئة SQLCipher في database_service.dart (خطأ الأقواس المتداخلة)
  - تصحيح طريقة فتح قاعدة البيانات المشفرة باستخدام المفتاح الآمن
  - ضمان الاستدعاء الصحيح لـ `initializeSqlCipherLibs()`
  - تنفيذ معالجة قوية للأخطاء عند فشل فتح قاعدة البيانات
- تعزيز تخزين المفاتيح باستخدام `flutter_secure_storage`:
  - تنفيذ طبقة إضافية من التشفير للمفتاح نفسه
  - ربط المفتاح بمعرف الجهاز الفريد لمنع نقل قاعدة البيانات بين الأجهزة
  - تنفيذ آلية لاسترداد المفتاح في حالة فقدانه
- اختبار الأداء: إجراء اختبارات أداء لقياس تأثير التشفير على سرعات الاستعلام
- فحص سلامة قاعدة البيانات: تنفيذ آلية للتحقق من سلامة قاعدة البيانات عند فتحها

### 2. استيراد البيانات من Excel/CSV
- تنفيذ نظام استيراد بيانات أساسي من ملفات CSV
- تحسين `excel_import_service.dart`:
  - إصلاح الأخطاء في معالجة قيم الخلايا من نوع `CellValue`
  - إضافة دعم لتنسيقات Excel المختلفة (.xlsx، .xls)
  - تنفيذ التعرف التلقائي على الأعمدة، حتى إذا اختلف الترتيب في الملف
  - إضافة دعم للترميز العربي (UTF-8) لضمان استيراد النص العربي بشكل صحيح
  - تنفيذ آلية للتعامل مع الخلايا الفارغة أو القيم غير الصالحة
- واجهة المستخدم لاستيراد البيانات:
  - إضافة شاشة لاختيار ملفات Excel/CSV من الجهاز
  - عرض معاينة للبيانات قبل الاستيراد
  - إظهار تقدم عملية الاستيراد
  - عرض تقرير عن نتائج الاستيراد (عدد السجلات المضافة/المحدثة/المرفوضة)

### 3. نظام النسخ الاحتياطي والاستعادة
- تنفيذ آلية إنشاء نسخة احتياطية أساسية
- تحسين `backup_service.dart`:
  - إصلاح الأخطاء في `backup_restore_screen.dart` المتعلقة بخدمة النسخ الاحتياطي
  - تشفير النسخ الاحتياطية باستخدام كلمة مرور المستخدم
  - ضغط النسخ الاحتياطية لتقليل حجمها
  - إضافة بيانات وصفية إلى النسخة الاحتياطية (الإصدار، تاريخ الإنشاء، عدد السجلات)
  - تنفيذ آلية للتحقق من سلامة النسخة الاحتياطية قبل الاستعادة

## المرحلة الثالثة: تطوير واجهة المستخدم (الأولوية: متوسطة)

### 1. تطوير واجهة المستخدم الأساسية
- إنشاء الهيكل الأساسي للتطبيق
- تنفيذ نظام للتنقل بين الشاشات
- تنفيذ دعم اللغتين العربية والإنجليزية
- تنفيذ الوضع الداكن
- تصميم وتنفيذ شعار التطبيق (حبة زرقاء مع رمز مفتاح ذهبي)
- تنفيذ سمة Material 3 في lib/main.dart
- تحسين تجربة المستخدم (UX) وتصميم واجهة المستخدم (UI) بألوان هادئة (أزرق طبي + رمادي)
- تنفيذ خط عربي واضح (Noto Sans Arabic) مع دعم RTL
- تنفيذ شاشة الإعدادات مع اختيار السمة واللغة
- تنفيذ انتقالات سلسة باستخدام flutter_animate
- تنفيذ تصميم متجاوب لجميع أحجام الشاشات (من iPhone SE إلى Samsung S24 Ultra)

### 2. شاشة البحث الذكي عن الأدوية
- تنفيذ واجهة البحث الأساسية
- تطوير نظام الاقتراح التلقائي أثناء الكتابة بكلتا اللغتين (تنفيذ جزئي)
- إضافة عرض صور توضيحية للأدوية في نتائج البحث
- تنفيذ مرشحات لتصفية النتائج (حسب السعر، الآثار الجانبية، تفاعلات الأدوية) (تنفيذ جزئي)
- إضافة خيار لتصفية النتائج حسب "مصري/دولي" أو "بوصفة طبية/بدون وصفة طبية"
- تحسين عرض نتائج البحث بمعلومات إضافية (التوفر، السعر، الشركة المصنعة)
- تنفيذ نظام تصحيح إملائي تلقائي في البحث
- إضافة تصفية النتائج حسب الفئة العلاجية (مصنفة تلقائيًا من CSV)
- تنفيذ التحميل الكسول (Lazy Loading) لعرض الأدوية عند التمرير
- تخزين صور الأدوية مؤقتًا باستخدام CachedNetworkImage

### 3. شاشة مقارنة الجرعات المكافئة
- تصميم وتنفيذ واجهة مقارنة الجرعات
- إنشاء نظام لتحويل الجرعات بين الأدوية المتشابهة
- تنفيذ دعم للوحدات المختلفة (ملغ/ميكروغرام) والتحويل التلقائي بينها
- تطوير رسوم بيانية توضح نسب الفعالية والسمية
- إضافة القدرة على مشاركة نتائج المقارنة
- إعادة تصميم وتنفيذ شاشة مقارنة الجرعات المكافئة (بسبب الأخطاء الحالية):
  - إصلاح مشكلة عرض مخطط المقارنة
  - إصلاح مشكلة عرض جدول المقارنة
  - تحسين واجهة المقارنة لتكون أكثر جاذبية وسهولة في الاستخدام
- إضافة ميزة اقتراح البدائل مع نسبة تشابه دقيقة

### 4. شاشة حاسبة جرعات الأدوية (حسب الوزن)
- تصميم وتنفيذ واجهة حاسبة الجرعات
- إنشاء نموذج لإدخال وزن المريض (بالكيلوغرام أو الرطل) مع تحديد العمر
- تنفيذ نظام لحساب الجرعات المخصصة بناءً على الوزن والعمر
- إعادة تصميم وتنفيذ شاشة حاسبة جرعات الأدوية (بسبب الأخطاء الحالية):
  - إصلاح مشكلة طريقة `getMedicationById` غير المعرفة
  - تحسين واجهة المستخدم وتجربة المستخدم
- إضافة تنبيهات فورية (صوتية + نص أحمر) عند تجاوز حدود الجرعة الآمنة
- تطوير ميزة لحفظ الحسابات ومشاركتها مع المريض أو الفريق الطبي

## المرحلة الرابعة: تطوير الخدمات الخلفية (الأولوية: متوسطة)

### 1. تطوير قاعدة البيانات
- إنشاء هيكل قاعدة البيانات الأساسي
- تنفيذ نظام لاستيراد البيانات من ملفات CSV
- توسيع نموذج الأدوية ليشمل معلومات (التفاعلات، الآثار الجانبية، الصور)
- إنشاء جداول إضافية للفئات والمكونات النشطة والشركات المصنعة
- إعادة تنفيذ تشفير البيانات باستخدام SQLCipher (AES-256)
- تحسين أداء الاستعلام وإضافة فهارس إضافية
- تنظيم الأدوية تلقائيًا في فئات (مسكنات، مضادات حيوية، إلخ)
- تنفيذ نظام لعرض تاريخ التحديث والسعر بجانب كل دواء

### 2. نظام تحديث البيانات من Excel/CSV
- إعادة تصميم وتنفيذ نظام استيراد البيانات من ملفات Excel:
  - تنفيذ آلية لمسح جميع البيانات القديمة واستبدالها بالبيانات الجديدة
  - معالجة الأخطاء تلقائيًا (مثل الأعمدة المفقودة)
  - تحويل البيانات من Excel إلى SQLite
- تنفيذ نظام تحديث البيانات دون الحاجة إلى إعادة نشر التطبيق
- إضافة نظام للتحقق من صحة البيانات المستوردة

### 3. خدمات البحث والمقارنة
- تنفيذ خدمة البحث الأساسية
- إعادة تنفيذ خدمة `getMedicationById`
- تطوير خوارزمية بحث ذكية (بالاسم التجاري أو المادة الفعالة)
- إنشاء نظام اقتراح بحث ذكي
- تنفيذ خدمة مقارنة الجرعات المكافئة
- تطوير خوارزمية حساب الجرعات بناءً على الوزن والعمر
- تحسين سرعة البحث (تحميل البيانات في <2 ثانية حتى على اتصال 2G)

## المرحلة الخامسة: تحسينات الأمان والأداء (الأولوية: منخفضة)

### 1. تحسينات الأمان
- إعادة تنفيذ نظام تشفير البيانات المخزنة محليًا باستخدام SQLCipher
- منع لقطات الشاشة للمعلومات الحساسة
- تنفيذ آلية للتحديثات التلقائية للتطبيق

### 2. تحسينات الأداء
- تحسين أداء قاعدة البيانات للاستعلامات المعقدة
- إعادة تصميم وتنفيذ نظام النسخ الاحتياطي والاستعادة
- إضافة تسجيل الأحداث لتتبع الأخطاء وتحسين الأداء
- تحسين أداء التطبيق للعمل بدون اتصال دائم بالإنترنت
- تحسين وقت البناء وتقليل حجم التطبيق النهائي

### 3. نظام الإعلانات والاشتراك
- تنفيذ نظام الإعلانات في الإصدار المجاني:
  - إعلانات بانر غير مزعجة في أسفل الشاشة
  - إعلانات Interstitial كل 10 استخدامات
- تطوير نظام اشتراك مدفوع (Premium):
  - إزالة الإعلانات للمشتركين
  - ميزة حفظ سجل البحث للمشتركين
  - تنبيهات تغيير الأسعار للمشتركين
- تنفيذ نظام الدفع الإلكتروني (سعر 1.99 دولار/شهر)
- ربط التطبيق بحساب Google AdMob لإدارة الإعلانات

## المرحلة السادسة: أفكار جديدة لتطوير التطبيق (الأولوية: منخفضة)

### 1. نظام تنبيه ذكي لتغييرات الأسعار
- تنفيذ آلية لتتبع تغييرات أسعار الأدوية:
  - مقارنة الأسعار الجديدة بالأسعار القديمة عند تحديث البيانات
  - تخزين تاريخ تغيير السعر ونسبة التغيير
  - عرض رسم بياني لتغييرات الأسعار مع مرور الوقت
- إضافة نظام تنبيه للمستخدمين:
  - تنبيه المستخدم عند تغيير سعر دواء في قائمة المفضلة
  - إمكانية تعيين سعر أقصى لتلقي تنبيه عندما ينخفض السعر دونه
  - تنبيهات لأدوية بديلة أرخص عندما يرتفع سعر دواء معين

### 2. تحسين أداء البحث باستخدام تقنيات الفهرسة المتقدمة
- تنفيذ فهرسة نصية متقدمة:
  - استخدام تقنيات البحث النصي الكامل لتحسين سرعة البحث
  - دعم البحث بكلمات مفتاحية متعددة
  - دعم البحث بعبارات دقيقة والبحث الضبابي
- تحسين خوارزمية البحث الذكية:
  - دعم التصحيح الإملائي التلقائي
  - دعم البحث بالمرادفات والمصطلحات الطبية المختلفة
  - ترتيب النتائج حسب الأهمية والصلة

### 3. إضافة ميزات تحليلية للأطباء والصيادلة
- تنفيذ نظام تحليل متقدم لتفاعلات الأدوية:
  - تحليل التفاعلات بين أكثر من دواءين في نفس الوقت
  - تصنيف التفاعلات حسب الشدة والتأثير
  - تقديم توصيات لتجنب التفاعلات الخطيرة
- إضافة أداة لتحليل الوصفات الطبية:
  - إمكانية إدخال قائمة بأدوية المريض
  - تحليل التفاعلات والتداخلات بين الأدوية
  - اقتراح بدائل أكثر أمانًا أو فعالية

## خطة عمل لإصلاح الأخطاء وإعادة تصميم الأدوات

### المرحلة 1: إصلاح الأخطاء الحرجة
1. إصلاح مشكلة تهيئة SQLCipher في `database_service.dart`
2. إصلاح الأخطاء في `dose_comparison_screen.dart`
3. إضافة طريقة `getMedicationById` إلى `DatabaseService`
4. إصلاح الأخطاء في `backup_restore_screen.dart`

### المرحلة 2: إعادة تصميم الأدوات الأساسية
1. إعادة تصميم وتنفيذ نظام تشفير البيانات باستخدام SQLCipher
2. إعادة تصميم وتنفيذ نظام النسخ الاحتياطي والاستعادة
3. إعادة تصميم وتنفيذ نظام استيراد البيانات من ملفات Excel/CSV

### المرحلة 3: تحسين واجهات المستخدم
1. إعادة تصميم وتنفيذ شاشة مقارنة الجرعات المكافئة
2. إعادة تصميم وتنفيذ شاشة حاسبة جرعات الأدوية
3. تحسين واجهة البحث وعرض النتائج

### المرحلة 4: إضافة ميزات جديدة
1. تنفيذ نظام تنبيه تغيير الأسعار
2. تحسين أداء البحث باستخدام تقنيات الفهرسة المتقدمة
3. إضافة ميزات تحليلية للأطباء والصيادلة

## ملاحظات هامة
- يجب اختبار كل أداة بشكل منفصل قبل دمجها في التطبيق
- يجب إنشاء اختبارات وحدة لكل وظيفة جديدة
- يجب أن يكون التطبيق متوافقًا مع أنظمة التشغيل المستهدفة (Android 8.0+ و iOS 13+)
- يجب الالتزام بمعايير أمان البيانات وخصوصية المستخدم
- يجب إجراء اختبارات أداء دورية لضمان استجابة التطبيق
- يجب مراعاة بيئة العمل الحالية المذكورة في env.md عند إضافة أي تبعيات جديدة