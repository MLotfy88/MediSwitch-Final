بس الصفحة الرئيسية عندى المفر ض فيها ٤ اقسام

الفئات الطبية

الادية المحدثة -الادوية الشائعة

جميع الادوية


اللى بيظهر جميع الادوية فقط وباقى الاقسام مابتظهرش ولما باعمل ريفريش للصفحة الرئيسية بيختفى كل شئ ومابيظهرش غير عنوان قسم الادوية المحدثة فقط

المشكلة اللي بتواجهك واضحة من خلال اللوج، وهي على الأغلب ناتجة عن عدم اكتمال تحميل البيانات الخاصة بالأقسام الثلاثة الأولى (الفئات، الأدوية المحدثة، الشائعة) بسبب فشل إعادة بناء الواجهة نتيجة خطأ تنسيق التاريخ اللي كنا لسه بنتكلم عنه (LocaleDataException).

تحليل المشكلة:

1. بيانات الأقسام بيتم تحميلها فعليًا بنجاح

مثلًا:

[_loadSimulatedSections] Successfully loaded 8 recently updated drugs.
[_loadSimulatedSections] Successfully loaded 10 popular (random) drugs.
getAvailableCategories successful, found 12 categories.



2. لكن الواجهة (HomeScreen) مش بتعرضهم بسبب إنه لما التطبيق يحاول يبني الـ Widget اللي يعرض آخر تحديث للبيانات (غالبًا في عنوان القسم أو بجواره)، بيحصل Exception في DateFormat.


3. في حالة الـ refresh، بيحصل نفس الخطأ وبالتالي الـ UI بيتكسر أكثر ومابيظهرش غير Section واحد (اللي ما بيعتمدش على التاريخ).




---

الحل النهائي:

عندك نقطتين لازم تطبقهم علشان تصلح المشكلة تمامًا:

1. تهيئة بيانات اللغة قبل استخدام DateFormat

في ملف main.dart أو أي مكان قبل بناء الواجهة:

import 'package:intl/date_symbol_data_local.dart';

void main() async {
      WidgetsFlutterBinding.ensureInitialized();
        await initializeDateFormatting('en', null); // أو 'ar' لو بتستخدم اللغة العربية
          runApp(MyApp());
}

2. حماية استخدام DateFormat بشرط

في MedicineProvider.lastUpdateTimestampFormatted، غلف الكود بـ try-catch علشان تتجنب كسر الـ UI:

String get lastUpdateTimestampFormatted {
      try {
            final date = DateTime.fromMillisecondsSinceEpoch(lastUpdateTimestamp);
                return DateFormat.yMMMd('en').format(date); // أو 'ar'
      } catch (e) {
            print('Error formatting timestamp: $e');
                return '---';
      }
}


---

لو عايز حل مؤقت:

تقدر مؤقتًا تعطل استخدام DateFormat في الأكواد اللي بتستخدمه (وخاصة SettingsScreen أو HomeScreen) لغاية ما تعمل التهيئة المطلوبة.


---

تحب أساعدك أعدل الكود لو بعتلي ملفات main.dart و medicine_provider.dart؟ أو تقدر تبعت سطر 109 تحديدًا؟


      }
      }
}
}