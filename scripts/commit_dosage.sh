#!/bin/bash
# Commit dosage guidelines updates to repository
# This script is called by GitHub Actions after successful dosage extraction

set -e  # Exit on error

echo "ðŸ”„ Committing dosage guidelines updates..."

# Configure Git
git config user.name "GitHub Actions Bot"
git config user.email "actions@github.com"

# Check if there are changes
if git diff --quiet assets/data/dosage_guidelines.json; then
    echo "â„¹ï¸  No changes detected in dosage_guidelines.json"
    exit 0
fi

# Stage the dosage guidelines file
git add assets/data/dosage_guidelines.json

# Stage backup if it exists
if [ -d "assets/data/backups" ]; then
    git add assets/data/backups/dosage_guidelines_backup_*.json 2>/dev/null || true
fi

# Create commit message with statistics
COMMIT_MSG="chore: update dosage guidelines (${DOSAGE_COUNT:-N/A} guidelines)"

# Get detailed statistics for commit body
STATS=$(python3 -c "
import json
import os

try:
    with open('assets/data/dosage_guidelines.json', 'r') as f:
        data = json.load(f)
    
    total = len(data)
    with_standard = sum(1 for g in data if g.get('standard_dose'))
    with_max = sum(1 for g in data if g.get('max_dose'))
    with_label = sum(1 for g in data if g.get('package_label'))
    
    print(f'Total guidelines: {total:,}')
    print(f'With standard dose: {with_standard:,} ({with_standard/total*100:.1f}%)')
    print(f'With max dose: {with_max:,} ({with_max/total*100:.1f}%)')
    print(f'With package label: {with_label:,} ({with_label/total*100:.1f}%)')
except Exception as e:
    print(f'Could not generate statistics: {e}')
")

# Create full commit message
FULL_COMMIT_MSG="${COMMIT_MSG}

ðŸ“Š Statistics:
${STATS}

ðŸ¤– Auto-generated by GitHub Actions
ðŸ“… $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

# Commit changes
git commit -m "$FULL_COMMIT_MSG"

# Push changes
echo "ðŸ“¤ Pushing changes to repository..."
git pull --rebase origin main
git push

echo "âœ… Dosage guidelines successfully committed and pushed"
