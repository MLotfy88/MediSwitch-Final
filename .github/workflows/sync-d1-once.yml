name: Sync Full Database to D1 (One-time)

on:
  workflow_dispatch:  # ÙŠØ¹Ù…Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·

jobs:
  sync-d1:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack - Start
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: MediSwitch Bot
          SLACK_ICON_EMOJI: ':database:'
          SLACK_COLOR: '#007ec6'
          SLACK_MESSAGE: 'ğŸ—„ï¸ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¥Ù„Ù‰ D1...'
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Check if d1_import.sql exists
        run: |
          if [ ! -f d1_import.sql ]; then
            echo "âŒ Error: d1_import.sql not found!"
            echo "Run: python3 scripts/export_to_d1.py"
            exit 1
          fi
          
          # 1. Generate Dosages SQL
          python3 scripts/export_dosages_full.py
          
          # 2. Generate Interactions SQL (Rules + Ingredients)
          python3 scripts/upload_interactions_d1.py assets/data/interactions/
          
          # 3. Generate Food Interactions SQL
          python3 scripts/export_food_interactions.py
          
          DRUG_COUNT=$(grep -c "INSERT INTO drugs" d1_import.sql || echo "0")
          DOSAGE_COUNT=$(grep -c "INSERT INTO dosage_guidelines" d1_dosages_part_*.sql | awk -F: '{s+=$2} END {print s}' || echo "0")
          INT_COUNT=$(grep -c "INSERT INTO drug_interactions" d1_rules_part_*.sql | awk -F: '{s+=$2} END {print s}' || echo "0")
          FOOD_COUNT=$(grep -c "INSERT INTO food_interactions" d1_food_interactions.sql || echo "0")
          
          echo "ğŸ“Š Drug records: $DRUG_COUNT"
          echo "ğŸ“Š Dosage records: $DOSAGE_COUNT"
          echo "ğŸ“Š Interaction records: $INT_COUNT"
          echo "ğŸ“Š Food records: $FOOD_COUNT"
      
      - name: Upload to Cloudflare D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloudflare-worker
          
          echo "ğŸš€ Uploading drugs database to D1..."
          wrangler d1 execute mediswitsh-db --file=../d1_import.sql --remote
          
          echo "ğŸ’Š Uploading dosage guidelines to D1..."
          for f in ../d1_dosages_part_*.sql; do
            echo "Processing $f..."
            wrangler d1 execute mediswitsh-db --file=$f --remote
          done
          
          echo "ğŸ§ª Uploading clinical interactions to D1..."
          # Order matters: rules then ingredients
          for f in ../d1_rules_part_*.sql ../d1_ingredients_part_*.sql; do
            echo "Processing $f..."
            wrangler d1 execute mediswitsh-db --file=$f --remote
          done
          
          echo "ğŸ¥ª Uploading food interactions to D1..."
          wrangler d1 execute mediswitsh-db --file=../d1_food_interactions.sql --remote
          
          echo "âœ… Upload complete!"
      
      - name: Verify Upload
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloudflare-worker
          
          echo "ğŸ” Verifying data..."
          DRUGS=$(wrangler d1 execute mediswitsh-db --command="SELECT COUNT(*) as t FROM drugs;" --remote --json | jq -r '.[0].results[0].t')
          DOSAGES=$(wrangler d1 execute mediswitsh-db --command="SELECT COUNT(*) as t FROM dosage_guidelines;" --remote --json | jq -r '.[0].results[0].t')
          INTERACTIONS=$(wrangler d1 execute mediswitsh-db --command="SELECT COUNT(*) as t FROM drug_interactions;" --remote --json | jq -r '.[0].results[0].t')
          INGREDIENTS=$(wrangler d1 execute mediswitsh-db --command="SELECT COUNT(*) as t FROM med_ingredients;" --remote --json | jq -r '.[0].results[0].t')
          FOOD=$(wrangler d1 execute mediswitsh-db --command="SELECT COUNT(*) as t FROM food_interactions;" --remote --json | jq -r '.[0].results[0].t')
          
          echo "ğŸ“Š Results in D1:"
          echo "  - Drugs: $DRUGS"
          echo "  - Dosages: $DOSAGES"
          echo "  - Interactions: $INTERACTIONS"
          echo "  - Med-Ingredients Map: $INGREDIENTS"
          echo "  - Food Interactions: $FOOD"
          
          if [ "$DRUGS" -lt 20000 ]; then exit 1; fi
          if [ "$DOSAGES" -lt 20000 ]; then exit 1; fi
          if [ "$INTERACTIONS" -lt 50000 ]; then exit 1; fi
          if [ "$INGREDIENTS" -lt 50000 ]; then exit 1; fi
      
      - name: Send Slack - Success
        uses: rtCamp/action-slack-notify@v2
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: MediSwitch Bot
          SLACK_ICON_EMOJI: ':white_check_mark:'
          SLACK_COLOR: '#36a64f'
          SLACK_MESSAGE: |
            âœ… *ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¥Ù„Ù‰ D1 Ø¨Ù†Ø¬Ø§Ø­!*
            
            ğŸ“Š *Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:*
            â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©: ~25,500 Ø¯ÙˆØ§Ø¡
            
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ†ÙÙŠØ°>
      
      - name: Send Slack - Failure
        uses: rtCamp/action-slack-notify@v2
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: MediSwitch Bot
          SLACK_ICON_EMOJI: ':x:'
          SLACK_COLOR: '#ff0000'
          SLACK_MESSAGE: |
            âŒ *ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© D1*
            
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„>
